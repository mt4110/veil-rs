# veil/rules — ルールパック (Default, Remote, Local)

このディレクトリは `veil` の **ルールパック (Rule Packs)** を含んでいます。

ルールパックとは、ルールのバージョン管理されたバンドル（パターン、メタデータ、オプションとして名前付きバリデータを含む）であり、他のパックとマージすることで、スキャン時に使用される **実効ルールセット (Effective Rule Set)** を構築します。

設計の目標は以下の通りです:

* **決定論的 (Determinism)**: 同じ入力 → 同じ実効ルール。安定したマージ順序。
* **透明性 (Transparency)**: list/explain コマンドで、各ルールがどこから来たのか、なぜそれが採用されたのかを表示できる。
* **安全性 (Safety)**: リモートのルールは **データのみ** であり、任意のコード実行は行わない。
* **進化 (Evolution)**: パックはバージョン管理、署名、配布が可能。

---

## ディレクトリ構成

```
veil/
  rules/
    README.md
    default/
      00_manifest.toml
      *.toml
```

* `default/` は **組み込みのデフォルトルールパック** をデータファイルとして保持します。
* `00_manifest.toml` は **ロード順序** と **パックのメタデータ** (将来的な署名ポリシーを含む) を定義します。

---

## 概念

### ルールID (正準) (Rule ID (canonical))

ルールは正準IDによって識別されます。推奨される形式は以下の通りです:

* `namespace.category.name` (ドット区切り), 例: `creds.aws.access_key_id`
* IDはマージ後にグローバルに一意である必要があります。

エイリアスID (従来の `aws_access_key_id` のようなスネークケース) も存在できますが、正準IDに正規化される必要があります。
正規化はTOMLの作成者ではなく、エンジンによって実行されます。

### ルールパック (Rule Pack)

ルールパックは、集合的にルールを定義するTOMLファイルのセットです。

各TOMLファイルは以下を定義できます:

* `[pack]` メタデータ (ファイルごとに任意ですが推奨されます)
* `[[rules]]` エントリ (ルール定義)

パックは以下を持ちます:

* `pack_id` (文字列)
* `pack_version` (整数、単調増加)
* `schema_version` (整数)
* `source` (builtin/default_files/remote/local)
* オプションの署名ポリシー (以下参照)

### 実効ルールセット (Effective Rule Set)

エンジンは複数のソースを厳密な順序でマージし、実効ルールセットを生成します。

推奨されるマージ順序 (競合時は優先度の高いものが勝つ):

1. **builtin** (従来のRust埋め込みデフォルト、移行用)
2. **default_files** (`veil/rules/default`, このディレクトリ)
3. **remote** (ダウンロードされたルールパック)
4. **local** (`veil.toml` ルールの上書き / 追加)

この順序は「順に適用し、後から来たものが前のものを上書きする」として実装できます。
エンジンは `veil rules list/explain` のために来歴 (provenance) を記録すべきです。

---

## 決定論的なロード順序

単一のディレクトリパック (`default/`) 内では、ロード順序は安定的かつ明示的である必要があります。

`00_manifest.toml` は以下を定義します:

* どのファイルが含まれるか
* それらが適用される正確な順序
* オプションの制約 (例: 必須スキーマバージョン)

マニフェストが見つからない場合、エンジンはファイルシステムの探索によって順序を **推測してはいけません**。
(せいぜいファイル名を辞書順にソートする程度かもしれませんが、マニフェストが正準なメカニズムです。)

---

## バージョニングポリシー

2つのバージョン番号があります:

### `schema_version`

パックファイルを解釈するために使用されるTOMLスキーマを定義します。
TOMLの構造や意味が変わる場合 (破壊的変更) にのみインクリメントします。

### `pack_version`

同じスキーマ内でのコンテンツの進化を定義します。
ルールが変更 (追加/削除/修正) された場合にインクリメントします (スキーマが同じままでも)。

どちらも整数です。

推奨されるセマンティクス:

* `schema_version`: まれに変更。破壊的変更のみ。
* `pack_version`: 頻繁に変更。コンテンツのイテレーション。

---

## リモートルールと署名 (将来対応)

リモートルールパックは **信頼されていない入力** として扱われる必要があります。

原則:

* パックは **データのみ** (TOMLまたは同等)。埋め込みスクリプトなし。
* バリデータは **名前** (例: `"luhn"`) で参照され、既知の許可リストに対してのみ解決される。

署名ポリシー (計画):

* リモートパックの配布は以下を提供します:

  * `manifest` (パックのメタデータ)
  * `files` (パックのコンテンツ)
  * `signature` (各ファイルの正準ダイジェストセットとマニフェストに対する署名)
* エンジンは設定されたトラストストアに対して署名を検証します。

信頼モデル (組織ごとに選択):

* **Pinned key(s)**: リストされた公開鍵によって署名されたパックのみを受け入れる。
* **Pinned digest(s)**: 特定の既知のハッシュのみを受け入れる。
* **TOFU (Trust On First Use)**: 最初の署名を受け入れ、その後はそれを固定する (高セキュリティには推奨されません)。

マニフェストには意図を表現するフィールド (例: `signature.required = true`) が含まれますが、
実際の強制は常にローカルポリシー (設定) によって決定されます。

---

## 最小限のTOML構造 (リファレンス)

典型的なルールファイル:

```toml
[pack]
id = "default.cloud_keys"
version = 1
schema_version = 1
description = "Cloud credential patterns (high-confidence)"

[[rules]]
id = "creds.aws.access_key_id"
description = "AWS Access Key ID"
pattern = '''\b(AKIA|ASIA)[0-9A-Z]{16}\b'''
severity = "HIGH"
score = 85
category = "secret"
tags = ["credential","cloud","aws"]
```

注記:

* `pattern` は可読性のために `'''` を使用することが推奨されます。
* 追加のフィールド (context, allow/deny など) は、後方互換性があれば同じ `schema_version` で追加しても構いません。
  そうでない場合は `schema_version` を上げてください。

---

## ノンゴール (現時点)

* パック内での動的なコード実行は行わない。
* 明示的なユーザー/組織のポリシーなしでのリモートパックの自動更新は行わない。
* ファイル名の命名規則に基づく暗黙のマージルールは行わない。マニフェストが唯一の真実のソースである。

---

## 運用ガイダンス

* 小さな、テーマ別のファイルを好む (cloud keys / PII JP / formats / entropy)。
* `00_manifest.toml` は安定させ、レビュー可能に保つ。
* パックの更新はセキュリティに敏感な変更として扱う:

  * diffをレビューする
  * 実効ルールセットを比較するゴールデンテストを実行する
  * `veil rules list/explain` に来歴を記録する
