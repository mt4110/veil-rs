#!/usr/bin/env bash
set -euo pipefail

PAT='file:'"//"

# staged Markdown files only (Added/Copied/Modified/Renamed)
git diff --cached --name-only -z --diff-filter=ACMR -- '*.md' \
| while IFS= read -r -d '' f; do
    # deleted/odd entries guard
    [ -f "$f" ] || continue

    if grep -nF "$PAT" "$f" >/dev/null 2>&1; then
      echo "[FAIL] forbidden raw file URL detected in staged Markdown: $f" >&2
      grep -nF "$PAT" "$f" >&2 || true
      echo "" >&2
      cat <<'GUIDE' >&2
Fix guide:
- Replace file URLs with repo-relative paths, OR
- If you must mention file URLs in docs, write them guard-safe (e.g. `file:` + `//` separated),
  so the raw substring does not appear.
GUIDE
      exit 1
    fi
  done

exit 0
