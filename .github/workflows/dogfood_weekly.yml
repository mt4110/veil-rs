name: Weekly Dogfood

on:
  schedule:
    - cron: 30 0 * * 1 # Every Monday at 00:30 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  dogfood:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: weekly-dogfood
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: DeterminateSystems/nix-installer-action@v16
      - uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Calculate WEEK_ID
        id: week
        run: |
          # Calculate expected WEEK_ID (Tokyo time)
          # Currently strictly utilizing the previous logic: find last one or generate new one?
          # Spec says "WEEK_ID is calculated... fail-fast if empty".
          # Since this is "Weekly Dogfood", we probably want to *generate* for the *current* week?
          # Or are we processing the *last* week? "Weekly Dogfood" usually runs on Monday for the previous week?
          # The current logic found the *last* directory: `ls docs/dogfood ... tail -n1`.
          # If we are generating a *new* report, we need the Target Week.
          # Let's align with "cockpit dogfood weekly" command which should handle this.
          # For CI, we need to pass it or rely on CLI.
          # User spec 5.2: "WEEK_ID is calculated... CI also injects it".
          
          # Let's assume we want to generate for the *current* week (ISO).
          # date +%Y-W%V in Tokyo.
          export TZ=Asia/Tokyo
          WEEK_ID=$(date +%Y-W%V)
          echo "WEEK_ID=$WEEK_ID" >> $GITHUB_ENV
          
          if [[ -z "$WEEK_ID" ]]; then
            echo "Error: WEEK_ID is empty"
            exit 3
          fi

      - name: Run Dogfood Loop
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_AUTH_TOKEN: ${{ github.token }}
          WEEK_ID: ${{ env.WEEK_ID }}
        run: |
          # Clean previous build
          rm -rf dist/cockpit-build
          
          # Build
          nix build .#cockpit --out-link dist/cockpit-build
          
          # Run
          # Ensure WEEK_ID is passed or handled.
          # CLI spec says `cockpit dogfood weekly` (maybe with args?)
          # Spec 5.1: `nix run .#cockpit -- dogfood weekly`
          # We should pass WEEK_ID if the CLI supports it, or rely on internal calc.
          # For safety, we will pass it if CLI accepts it, OR just let CLI calc it and we verify.
          # But spec 5.2 says "CI side also calculates and injects".
          # We'll pass it as env var `WEEK_ID` (CLI likely reads it or we add arg).
          
          ./dist/cockpit-build/bin/cockpit dogfood weekly

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create/Update Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
          WEEK_ID: ${{ env.WEEK_ID }}
        run: |
          BRANCH_NAME="automation/dogfood/${WEEK_ID}"
          
          echo "Processing Week: $WEEK_ID on Branch: $BRANCH_NAME"

          # Safety: Check allowed modifications
          # Allowed: docs/dogfood/{WEEK_ID}-Tokyo/**, docs/dogfood/README.md
          # Ignored (should be handled by .gitignore but we double check): result/dogfood/**
          
          # git status --porcelain should show only docs/dogfood/
          CHANGED_FILES=$(git status --porcelain | awk '{print $2}')
          
          for file in $CHANGED_FILES; do
            if [[ "$file" != docs/dogfood/${WEEK_ID}-Tokyo/* ]] && [[ "$file" != "docs/dogfood/README.md" ]]; then
              echo "Error: Unexpected change in file: $file"
              echo "Only docs/dogfood/${WEEK_ID}-Tokyo/ and docs/dogfood/README.md are allowed."
              exit 10
            fi
          done

          # Check if we have changes
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No changes generated."
            exit 0
          fi

          # 1. Create/Checkout Branch
          git checkout -B "$BRANCH_NAME"
          git add docs/dogfood
          git commit -m "dogfood: ${WEEK_ID} (Tokyo)" || echo "No changes to commit"
          
          # Force push to update valid PR if exists
          git push origin "$BRANCH_NAME" --force

          # 2. Create PR if not exists
          PR_URL=$(gh pr list --head "$BRANCH_NAME" --json url --jq 'if length>0 then .[0].url else "" end')

          if [[ -z "$PR_URL" ]]; then
            gh pr create \
              --title "dogfood: ${WEEK_ID} (Tokyo)" \
              --body "Self-generated weekly audit report and worklist for ${WEEK_ID}." \
              --head "$BRANCH_NAME" \
              --base ${{ github.event.repository.default_branch }}
          else
            echo "PR already exists: $PR_URL"
            gh pr edit "$PR_URL" \
              --title "dogfood: ${WEEK_ID} (Tokyo)" \
              --body "Self-generated weekly audit report and worklist for ${WEEK_ID}."
          fi
