      - name: Run Dogfood Loop
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_AUTH_TOKEN: ${{ github.token }}
          WEEK_ID: ${{ env.WEEK_ID }}
        shell: bash
        run: |
          # Clean previous build
          rm -rf dist/cockpit-build

          # Build
          nix build .#cockpit --out-link dist/cockpit-build

          # Prepare directory
          OUTDIR="docs/dogfood/${WEEK_ID}-Tokyo"
          mkdir -p "$OUTDIR"

          # Run with log capture (receipts always exist)
          set -euo pipefail
          ./dist/cockpit-build/bin/cockpit dogfood weekly 2>&1 | tee "$OUTDIR/run.log"

      - name: Phase 14 Analysis
        if: always()
        env:
          WEEK_ID: ${{ env.WEEK_ID }}
        run: ./dist/cockpit-build/bin/cockpit dogfood analyze --week-id "$WEEK_ID"

      - name: Ensure Artifacts (Unbreakable Ritual)
        if: always()
        run: |
          TARGET_DIR="docs/dogfood/${WEEK_ID}-Tokyo"
          mkdir -p "$TARGET_DIR"

          # Required files list (Phase 13 + Phase 14, additive-only)
          REQUIRED_FILES=(
            "metrics_v1.json"
            "scorecard.txt"
            "run.log"
            "signals_v1.json"
            "INSIGHTS.md"
            "ACTIONS.md"
            "SUMMARY.md"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            FILEPATH="$TARGET_DIR/$file"
            if [[ ! -f "$FILEPATH" ]]; then
              echo "Creating placeholder for missing artifact: $file"
              case "$file" in
                *.json)
                  printf "[]\n" > "$FILEPATH"
                  ;;
                *)
                  printf "status: failed\nreason: Artifact generation failed or skipped\nremediation: Check workflow logs and run.log\ntimestamp: %s\n" "$(date)" > "$FILEPATH"
                  ;;
              esac
            fi
          done
