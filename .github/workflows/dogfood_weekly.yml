name: Weekly Dogfood

on:
  schedule:
    # Mon 23:00 JST = Mon 14:00 UTC
    # This cron is UTC. Equivalent in JST: Mon 23:00
    - cron: 0 14 * * 1
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dogfood:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Generate Dogfood
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_AUTH_TOKEN: ${{ github.token }}
        run: |
          # Use nix develop to get scorecard and other tools in path
          nix develop --command nix run .#cockpit -- dogfood

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Setup git user
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          git add docs/dogfood
          if git diff --staged --quiet; then
            echo "No changes generated."
            exit 0
          fi
          
          # Safe extraction of directory name
          # e.g. docs/dogfood/2025-W52-Tokyo/...
          NEW_DIR=$(git diff --name-only --cached | grep -E "^docs/dogfood/[0-9]{4}-W[0-9]{2}-Tokyo/" | head -n 1 | cut -d/ -f3)
          if [ -z "$NEW_DIR" ]; then
            echo "Could not detect new dogfood directory."
            NEW_DIR="Unknown"
          fi
          
          BRANCH_NAME="dogfood/${NEW_DIR}"
          
          git checkout -b "$BRANCH_NAME"
          git commit -m "docs(dogfood): add $NEW_DIR"
          git push -f origin "$BRANCH_NAME"

          # Create PR safely
          PR_EXISTS=$(nix develop --command gh pr list --head "$BRANCH_NAME" --json url --jq 'length')
          if [ "$PR_EXISTS" -gt 0 ]; then
            echo "PR already exists for $BRANCH_NAME. Skipping creation."
            exit 0
          fi

          nix develop --command gh pr create \
            --title "dogfood: $NEW_DIR (Tokyo)" \
            --body "Weekly dogfood generation.
            
            - metrics_v1.json
            - scorecard.txt
            - weekly.md
            
            p.s. Next: review deltas / tune thresholds." \
            --base main \
            --head "$BRANCH_NAME"
