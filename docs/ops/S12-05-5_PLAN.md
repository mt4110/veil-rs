Goal

ローカル開発で nix run .#prverify 相当が遅すぎる問題を、安全に高速化する。
手段：スコープ制御 + キャッシュ固定 + 上限付き並列（任意）。

Non-Goal

CIのfull挙動を変えること（禁止）

“常に並列”でCPU100%にして端末を殺すこと（禁止）

Invariants

exit系全面禁止（shell/Python/Go含む）

stdoutは OK: / ERROR: / SKIP: のみ（必要なら KEY=VALUE）

失敗はログで表現し、制御はフラグ（STOP等）で表現

デフォルト（CIが使う）挙動は fullのまま

ローカル高速化は 明示 opt-in（例：--mode local-fast / --parallel 2 など）

Interface（追加する外部仕様）

prverify --mode full（既存デフォルト。CI互換・変更禁止）

prverify --mode local-fast（ローカル専用）

prverify --parallel N（デフォ1、最大2。2は明示指定のみ）

prverify --cache-dir .local/cache（デフォ固定：repo内.local配下）

Algorithm（疑似コード：止まらない版）
STOP = 0
MODE = args.mode default "full"
PARALLEL = args.parallel default 1
CACHE_DIR = args.cache_dir default ".local/cache"
OBS_DIR = ".local/obs/s12-05-5_prverify_<UTC>"

STEP: init
  mkdir OBS_DIR
  print OK: obs_dir=...
  print OK: mode=... parallel=...

STEP: resolve_base
  BASE_SHA = git merge-base HEAD origin/main
  if empty:
    BASE_SHA = git merge-base HEAD main
  if empty:
    print ERROR: base_sha=missing fallback=full
    MODE = "full"   # “不確実なら full” が安全弁
  else:
    print OK: base_sha=...

STEP: classify_changes (only if MODE == "local-fast" and BASE_SHA != empty)
  files = git diff --name-only BASE_SHA..HEAD
  if fail:
    print ERROR: diff_failed fallback=full
    MODE="full"
  else:
    TOUCH_GO   = any match (*.go, go.mod, go.sum)
    TOUCH_RUST = any match (*.rs, Cargo.toml, Cargo.lock, rust-toolchain*, .cargo/)
    TOUCH_NIX  = any match (flake.nix, flake.lock, *.nix)
    TOUCH_DOCS = any match (*.md, docs/**)
    TOUCH_OTHER = any remaining

    print OK: touch_go=... touch_rust=... touch_nix=... touch_docs=... touch_other=...

STEP: decide_plan
  if MODE == "full":
     RUN: go_checks + rust_checks + other_full_checks (current behavior)
  else if MODE == "local-fast":
     if TOUCH_GO == 0: SKIP go_checks with reason
     if TOUCH_RUST == 0: SKIP rust_checks with reason
     if nothing touched except docs:
        SKIP heavy checks with reason "docs_only"
        (optional: run ultra-light sanity if exists, but do not invent new heavy steps)
     if TOUCH_OTHER == 1:
        print ERROR: unknown_changes fallback=full
        MODE="full"

STEP: caching (only when executing that language)
  ensure CACHE_DIR exists
  if go_checks:
     set env GOCACHE=CACHE_DIR/go-build
     (optional) set env GOMODCACHE=CACHE_DIR/go-mod
  if rust_checks:
     set env CARGO_TARGET_DIR=CACHE_DIR/cargo-target
  print OK: cache_go=... cache_rust=...

STEP: execute (safe parallel)
  if PARALLEL <= 1:
     run steps sequentially (each step logs duration_ms)
  else if PARALLEL == 2:
     run go_checks and rust_checks concurrently with bounded workers=2
     (never spawn more than 2 heavy jobs)
  else:
     print ERROR: parallel_too_high capped_to=2
     PARALLEL=2 then proceed

STEP: final
  always print OK: phase=end stop=STOP
DoD

nix run .#prverify（full）は挙動不変（PASS/FAILの出力規約も不変）

nix run .#prverify -- --mode local-fast で

Go-only変更 → Rustチェックが SKIP: になり、体感が明確に速い

Rust-only変更 → Goチェックが SKIP: になり、体感が明確に速い

.local/obs/... に step別duration が残る（監査ログ）

--parallel 2 は明示時のみ。デフォは並列しない
