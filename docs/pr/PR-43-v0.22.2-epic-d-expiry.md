---
release: v0.22.2
epic: D
pr: 43
status: proposed
created_at: 2026-02-08
branch: feat/v0.22.2-epic-d-pr43-expiry
title: Expiry Enforcement
---

## Intent
Enforce expiry dates in the **Exception Registry v1** (`ops/exceptions.toml`).
This converts "expiry" from a metadata field into a **enforced contract**.

## Contract
1. **Determinism**:
   - `utc_today` is computed **once** as `time.Date(..., 0, 0, 0, 0, time.UTC)`.
   - Output is a pure function of `(registry, utc_today)`.
   - Sort Order: `ID asc`, strictly. Fallback to `Index asc`.
2. **Expiry Rule**: `utc_today > expires_at` (Strictly after).
   - `expires_at` format: `YYYY-MM-DD`
   - `expires_at` missing: Allowed.
   - Parse Error: **FAIL** (Registry Error).
3. **UX (1-scroll)**:
   - One-line summary with `(utc_today=YYYY-MM-DD)`.
   - Max **10** expired items shown.
   - `... and N more` if capped.
   - Footer:
     - `Fix: Correct the invalid entries in ops/exceptions.toml`
     - `Next: nix run .#prverify`

## Change Summary
- **Logic**:
  - `cmd/prverify/main.go`: Compute `utcToday` (Midnight UTC).
  - `cmd/prverify/registry.go`: Implement expiry check, sorting (slice), and capping.
- **Verification**:
  - Unit tests for all 5 mandated cases (Logic/Boundary/Ordering/Capping).
  - Integration tests via `prverify`.

## Verification
- `go test ./...`
- `nix run .#prverify`

## Evidence
- `go test ./...` (PASS)
- `nix run .#prverify` (PASS)
- `sqlx_cli_install.log` (Not Applicable - Runtime Verified)
- `SQLX_OFFLINE` (Checked)
