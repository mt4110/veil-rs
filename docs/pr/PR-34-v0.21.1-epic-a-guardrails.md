---
release: v0.21.1
epic: A
pr: "#34"
status: review
created_at: 2026-02-03
branch: feature/v0.21.1-guardrails
commit: 67720e31597cb9aafe4e031624d0704d13c8617f
title: ci: guardrails (future-incompat + sqlx prepare)
---

## Overview
- Add CI guardrails for Rust future-incompatibilities and SQLx offline query cache verification.
- Upload guardrail logs as artifacts and document recovery steps for fast triage.

## Goals
- [x] CIで `cargo check --future-incompat-report` を実行し、ログをartifactに残す
- [x] `cargo report future-incompatibilities` は「レポート無し＝正常」として扱い、ある時だけ保存する
- [x] CIで `sqlx-cli` が無い穴を塞ぎ、`SQLX_OFFLINE=true cargo sqlx prepare --check --workspace` を保証する
- [x] `.local/ci/*` を artifact upload して、落ちた時に “ログから即復旧” できるようにする
- [x] SOT運用で PATH の古い `veil` 罠を回避する注意書きを docs に残す

## Non-Goals
- 依存関係のアップグレード自体（警告が出たら別PR/別Epicで扱う）
- Dependabotの脆弱性修正（このPRのスコープ外）
- CIの高速化（cache最適化などは後続で）

## Design

### CI（.github/workflows/ci.yml）

#### future-incompat guardrail
- 実行：
  - `cargo check --workspace --all-targets --future-incompat-report`
- ログ保存：
  - `.local/ci/check_future_incompat.log`（常に作る）
- レポートの扱い（重要）：
  - `cargo report future-incompatibilities` は「レポートが無い」状態で **exit 101** になり得るが、これは **正常**。
  - レポートが存在する場合のみ `.local/ci/future_incompat.txt` を保存し、無い場合はファイルを残さない。

#### sqlx guardrail
- 準備：
  - `sqlx-cli` (v0.8.6) をインストール（CI環境に無い場合）。
  - **Robustness**: Cache (`~/.cargo/registry` + `git`), Retry (max 3), Log (`.local/ci/sqlx_cli_install.log`).
- 実行：
  - `SQLX_OFFLINE=true cargo sqlx prepare --check --workspace`
- 目的：
  - オフラインキャッシュ `sqlx-data.json` と実際のクエリコードの整合性を保証する。

#### artifacts
- `.local/ci/*` を upload-artifact する。

### Docs
- `docs/guardrails/future-incompat.md`: 未来の非互換性警告への対応方針と復旧手順。
- `docs/guardrails/sqlx.md`: SQLxチェックの目的とキャッシュ更新手順。
- `docs/pr/README.md`: `veil` コマンドバージョン不一致への注意喚起。

## Verification
- [ ] `nix run .#prverify` PASS
- [x] future-incompat（ローカル）で note: 0 dependencies had future-incompatible warnings を確認
- [x] SQLx prepare（ローカル） PASS を確認

## Risks / Rollback
### Risks
- CIで `sqlx-cli` をインストールするため、ネットワーク不調で落ちる可能性（将来的にcache導入で軽減）。
- `cargo report` の仕様（エラー扱い）に対する誤解（docsでカバー）。

### Rollback
- `git revert <this_pr_commits>` で差し戻し可能（guardrail追加だけなので影響局所）。

## Audit Notes
### Evidence
- CI Run: https://github.com/mt4110/veil-rs/actions/runs/21629947456
- prverify report: `.local/prverify/prverify_20260203T012502Z_f10e600.md`
- artifacts:
  - `.local/ci/check_future_incompat.log`（常に）
  - `.local/ci/future_incompat.txt`（レポートがある時だけ）
  - `.local/ci/sqlx_cli_install.log`（インストール試行時）
  - `.local/ci/sqlx_prepare_check.txt`
