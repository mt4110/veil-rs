---
release: v0.22.0
epic: A
pr: 35
status: review
created_at: 2026-02-05
branch: feature/v0.22.0-robust-sqlx
commit: e5db34aee55829571cad28ac51f009722429e2ee
title: Robust SQLx Install & CI Guardrails
---

## Overview
Implement robust SQLx installation in CI to prevent network flake failures and strictly observe guardrail evidence.

## Goals
- [x] Make `sqlx-cli` install robust against network issues (retry logic, pinned version).
- [x] Enforce "observation point fixing" in CI (fail if logs are missing).
- [x] Allow `ops/ci/*.sh` as an exception to the no-shell-script rule.

## Non-Goals
- [ ] Refactoring the entire CI pipeline to Nix (scope is limited to stabilization).

## Design
### CI Changes
- `no-shell-scripts`: Added exception for `ops/ci/*.sh`.
- `stable`: Uses `ops/ci/install_sqlx_cli.sh` for deterministic installation.
- Artifacts: Enforced uploads of `.local/ci/` logs.

### Files / Formats
- `ops/ci/install_sqlx_cli.sh`: Installation script with version pinning and retries.

## Verification
- [x] `git ls-files` check passes (ignores `ops/ci/`).
- [x] `bash ops/ci/install_sqlx_cli.sh` runs successfully.
- [x] `nix run .#prverify` passes.

## Risks / Rollback
- Risks: SQLx version mismatch if upstream releases breaking changes (mitigated by pinning).
- Rollback: Revert to previous `ci.yml` state.

## Audit Notes
- Evidence:
  - `.local/ci/sqlx_cli_install.log`: CI logs showing successful SQLx install.
  - `.local/ci/sqlx_prepare_check.txt`: Logs showing `SQLX_OFFLINE=true` preparation check.
  - SOT file updated.
