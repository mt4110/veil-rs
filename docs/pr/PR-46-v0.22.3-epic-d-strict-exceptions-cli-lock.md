# PR-46 (SOT) — Strict Exceptions CLI Flags & strict_lock_busy 復活（v0.22.3 / Epic D）

* PR: 46
* Title: Strict Exceptions CLI Flags（--system-registry / --strict-exceptions）& strict_lock_busy 復活
* Target Release: v0.22.3（暫定）
* Epic: D（暫定）
* Owner: mt4110
* Status: Draft
* Created (JST): 2026-02-09
* Branch: feature/pr46-strict-exceptions-cli-lock（例）
* SOT Commit: <TBD: git sha>  （このSOTが指す実装HEAD）

---

## 0. このPRの"勝ち筋"（CI/CD地獄回避のための不変条件）

### Invariants（絶対に破ってはいけない）

1. **無限待ち禁止**（lock/IO/外部プロセスは必ず上限 or 即fail）
2. **決定論**（同じ入力→同じ出力：パス解決、strict判定、exit code、メッセージ）
3. **1スクロール復旧**（失敗時に「何が/どこで/なぜ/次の一手」が出る）
4. **入口は `nix run .#prverify`**（CI/ローカルで同じ真理）
5. **既定挙動を壊しにくい**（strictはフラグで明示。非strictは警告に落として継続）

---

## 1. Context（背景）

Exception Registry v1 は導入済み（ops/exceptions.toml + parser/validator + wiring + tests）。
運用の次の痛点は以下：

* 例外レジストリの参照元（repoローカル vs system共通）が曖昧だと、CIが**環境ガチャ**になる。
* lock busy が"待ち"や"ハング"に見えると、CIも人間も止まる。

PR46は、CLIフラグで**入力ソースと厳格性を固定**し、`strict_lock_busy` を復活させて **寝てても回る** 運用にする。

---

## 2. Goal（目的）

### 2.1 Functional Goals

* `--system-registry`
  例外レジストリの参照元を system registry の既定パスに固定できる。
* `--strict-exceptions`
  例外レジストリが missing/invalid/expired 等なら即失敗する。
* `strict_lock_busy`
  lock busy 時に strict モードでは即失敗し、復旧可能なエラーメッセージを出す。

### 2.2 Operational Goals（CI/CD安定）

* ハングしない（タイムアウト/即fail）
* 失敗原因が明確（ログが短くても分かる）
* PR/Push/手動/定期で常に同じ入口が動く（Run Always）

---

## 3. Non-Goals（今回やらない）

* レジストリ仕様の刷新（複数ファイルマージ、探索増殖）
* インタラクティブUI（TUI/GUI）
* "勝手に修復"（自動削除/自動書換え）
* OSごとの複雑探索（長期で壊れるため）

---

## 4. Spec（仕様）

### 4.1 Registry Source Resolution（参照元の決定規則：最重要）

**優先順位（固定）**：

1. `--system-registry` 指定 → `SystemDefaultPath`
2. （存在する場合）`--exceptions <PATH>` 指定 → `ExplicitPath(PATH)`
3. repo 既定（例：`ops/exceptions.toml`）が存在 → `RepoDefaultPath`
4. どれも無い → `None`

**排他**：

* `--system-registry` と `--exceptions <PATH>` の同時指定は **即エラー**（曖昧禁止）

### 4.2 SystemDefaultPath

* 既存規約があればそれを採用し、新規規約を増やさない。
* 無い場合の暫定：Unix系 `/etc/veil/exceptions.toml`

  * ※最終的にプロジェクトの既定へ寄せる。

### 4.3 `--strict-exceptions`（strict範囲）

strict = **例外レジストリ周りだけ**を厳格化。

strict時に即エラー：

* missing / unreadable（`None` も含む）
* TOML parse error
* schema validation error
* expiry enforcement が有効なら expired

non-strict時：

* 上記は **警告**に落として継続
* ただし「例外が適用されない/無効化された」ことが分かるログを必ず出す

### 4.4 `strict_lock_busy`（復活）

* strict_lock_busy=true：

  * lock busy → **即失敗（待機なし）**
  * エラーに必須：lock対象 / 状況(busy) / 次の一手（復旧手順）
* strict_lock_busy=false：

  * 待機があるなら必ず上限時間を設ける（無限待ち禁止）
  * 上限超過はタイムアウトとして失敗＋復旧手順

---

## 5. Design（実装設計：CI安定のための構造）

### 5.1 Pure-Function First（差分局所化）

下記の"意思決定"は純関数に寄せてテストで固定する：

* RegistrySource の解決：`resolve_registry_source(args, fs_probe) -> Result<RegistrySource, CliError>`
* strict適用：`apply_strictness(strict, load_result) -> Result<Option<Registry>, FatalOrWarn>`
* lock取得：`acquire_lock(opts{strict_lock_busy, max_wait}) -> Result<LockGuard, LockError>`

※ 実際の関数名は既存の命名に合わせる（新概念増殖を避ける）。

### 5.2 Error Message Contract（1スクロール復旧）

strictで落ちるときの出力に必須：

* 結論（何が起きたか）
* Path / Lock（どこで）
* Reason（なぜ）
* Fix（次の一手）

---

## 6. Implementation Plan（PR分割なし：緑を保つ順）

### T1: 現状把握（差分最小化）

* CLI引数定義箇所
* 例外レジストリのロード地点
* lock実装箇所（`strict_lock_busy` が死んだ箇所の追跡）

### T2: CLI flags 追加（parse + 排他）

* `--system-registry`
* `--strict-exceptions`
* `--system-registry` と explicit path が同時なら即エラー

### T3: registry解決ロジック純関数化 + 単体テスト

* 優先順位の固定
* `None` の取り扱いの固定
* strict/non-strictの分岐点を1箇所に集約

### T4: strict_lock_busy 復活（配線） + 結合テスト

* strict時：即失敗
* 非strict時：待機があるなら上限時間導入
* エラーメッセージに復旧手順が含まれることを検証

### T5: CLI help / docs / runbook 更新

* `--help` の説明追加
* runbook（該当あれば）に "CIでは strict推奨" と "system-registryを使うなら配置必須" を追記

### T6: prverifyで証拠確定

* `cargo test --workspace`
* （該当があるなら）`cargo test -p veil-cli --test cli_tests`
* `nix run .#prverify`

---

## 7. Acceptance Criteria（マージ判定）

### Functional

* [ ] `--system-registry` で参照先が確実に切り替わる（テストあり）
* [ ] `--strict-exceptions` でレジストリ不正が即エラーになり、原因＋復旧が分かる
* [ ] non-strict は警告で継続し、例外が効いていないことが分かる
* [ ] `strict_lock_busy` が strict 時に即失敗し、復旧手順が出る
* [ ] exit code が安定している（同条件でブレない）

### CI/Quality

* [ ] `cargo test --workspace` ✅
* [ ] `nix run .#prverify` ✅
* [ ] ハングしない（lock待機は上限/即fail）

---

## 8. Evidence（証拠の貼り方：この通りに残す）

### 8.1 Commands（必須）

```bash
# 1) Unit/Integration tests
cargo test --workspace

# 2) (必要なら)
cargo test -p veil-cli --test cli_tests

# 3) PR証拠（入口はこれ）
nix run .#prverify
```

### 8.2 Artifacts（保存先の推奨）

* prverify レポート：

  * `.local/prverify/prverify_<UTC_TIMESTAMP>_<GIT_SHA7>.md`
* 参照しやすいように、このSOTに**最新のパスを1行で貼る**：

**Latest prverify report:** `<TBD: .local/prverify/prverify_...md>`

（例）

* Latest prverify report: `.local/prverify/prverify_20260209T123456Z_abcdef0.md`

### 8.3 "差分証拠"の残し方（任意だが推奨）

* `git show --stat HEAD` の出力を、prverifyのログに含める or SOTに貼る
* 変更ファイルが多い場合は "要点だけ" を残す（CIログが主証拠で良い）

---

## 9. Risk & Mitigation（地獄の芽を事前証明で潰す）

### Risk A: system registry path が存在しない

* strict：意図通り落ちる（原因＋復旧が出る）
* non-strict：警告で継続し、例外が無効化されることが分かる

### Risk B: lock busy の再現が不安定

* テストは最優先で "安定にbusyを作れる方法" を選ぶ
* 子プロセス方式なら必ずタイムアウト＆回収

### Risk C: 待機がハングする

* strictは即fail
* 非strictも上限時間を必須（無限待ちを許さない）

---

## 10. Rollback Plan（戻し方）

* フラグ追加が原因で壊れた場合：

  * CLIフラグの parsing を残しつつ、実動作は従来挙動に戻す（段階的に戻せる）
* lock周りで事故った場合：

  * strict_lock_busy の適用箇所を限定（CLIからの配線を一旦外す）し、まずはCIを復旧

---

## 11. Release Notes Draft（下書き）

### Added

* Add `--system-registry` to force using the system-wide exceptions registry.
* Add `--strict-exceptions` to fail fast when exceptions registry is missing/invalid/expired.
* Restore `strict_lock_busy` behavior to avoid hangs on lock contention.

### Changed

* Exceptions registry source resolution is now explicit and deterministic when flags are used.

### Fixed

* Prevent potential CI hangs caused by lock contention by failing fast in strict lock mode with recovery hints.

---

## 12. Checklist（作業チェックリスト）

### Implementation

* [ ] CLI: `--system-registry` / `--strict-exceptions` を追加
* [ ] 排他：system + explicit path の同時指定は即エラー
* [ ] Registry source 解決ロジックを純関数化
* [ ] strict適用を1箇所に集約（fatal/warn の分岐を固定）
* [ ] `strict_lock_busy` を復活させて配線

### Tests

* [ ] registry source 優先順位テスト
* [ ] strict/non-strict の missing/parse/schema/expired の挙動テスト
* [ ] lock busy の strict 即fail テスト（安定再現）
* [ ] エラーメッセージに復旧手順が含まれることの検証

### Docs

* [ ] `--help` 更新
* [ ] runbook / docs の追記（CI推奨・system-registryの前提）

### Evidence

* [ ] `cargo test --workspace` ✅
* [ ] `nix run .#prverify` ✅
* [ ] Latest prverify report パスを SOT に記入

---

## Appendix: Notes

* v0.22.3 / Epic D は暫定。確定値に更新すること。
* `SystemDefaultPath` はプロジェクト既存規約があれば必ずそれに寄せる（新規規約増殖を避ける）。
